{% load static %}
{% load price_filters %}

{% for video in videos %}
{% if not video.processing %}
<div class="reel" data-video-id="{{ video.id }}">
    <!-- 🎥 Video with lazy loading -->
    <video 
        class="reel-video"
        loop 
        playsinline 
        muted
        preload="none"
        data-src="{{ video.video.url }}">
        <source data-src="{{ video.video.url }}" type="video/mp4" />
        Your browser does not support the video tag.
    </video>

    <!-- Loading spinner -->
    <div class="video-loading absolute inset-0 flex items-center justify-center bg-gray-900">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>

    <!-- 🔈 Mute/Unmute Status Icon -->
    <div class="mute-status-icon absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white z-50 text-5xl pointer-events-none opacity-0">
        <span class="material-icons">volume_off</span>
    </div>

    <!-- 📍 Top Left Info -->
    <div class="top-left-info">
        <div class="flex items-center space-x-2">
            <span class="material-icons text-lg text-red-600">location_on</span>
            <span class="text-lg font-medium text-white">{{ video.area }}</span>
        </div>
        
        <div class="flex items-center space-x-2">
            <!-- Inline SVG for house -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-6 h-6">
                <path fill="#ff6e6e" d="M256 64L64 224h48v224h112V320h64v128h112V224h48z" />
                <path fill="#ffcc66" d="M112 448V224L256 96l144 128v224H304V320h-96v128z" />
            </svg>
            <span class="text-lg font-medium text-white">{{ video.properties }}</span>
        </div>
    </div>

    <!-- 📦 Bottom Info -->
    <div class="reel-content text-base leading-relaxed space-y-3 mt-4 text-gray-100">
        <div class="flex flex-wrap items-center gap-2">
            <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                RERA: {{ video.rera }}
            </span>
            <span class="bg-gray-900 text-white px-3 py-1 rounded-full text-sm font-semibold">
                Token: ₹{{ video.token_amount }}
            </span>
        </div>
        
        <div>
            <a href="{% url 'details' video.id %}?from={{ request.get_full_path|urlencode }}"
               class="text-blue-400 font-semibold underline hover:text-blue-300 transition">
                Broker Details:
            </a>
            <span class="ml-1 font-medium">
                {{ video.agent.user.first_name }} {{ video.agent.user.last_name }}
            </span>
        </div>
        
        
        <div class="space-y-1">
            {% if video.agent.company_name %}
                <p><strong>Company:</strong> {{ video.agent.company_name }}</p>
            {% endif %}
            {% if video.project_name %}
                <p><strong>Project:</strong> {{ video.project_name }}</p>
            {% endif %}
            <p><strong>Price:</strong> ₹{{ video.price|format_inr }}</p>
            <p><strong>guideline:</strong> ₹{{ video.guideline_per_sqft }}/sqft</p>
            <p><strong>Size:</strong> {{ video.property_size_sqft }} sqft</p>
        </div>
    </div>

    <!-- 🔘 Sidebar Actions -->
    <div class="actions-sidebar">
        <a class="action-item" href="{% if user.is_authenticated %}
                                          {% url 'log-call' video.id %}
                                      {% else %}
                                          {% url 'user-login' %}?next={{ request.get_full_path|urlencode }}
                                      {% endif %}">
            <span class="material-icons">call</span>
            Call Broker
        </a>
        
        <a class="action-item" href="{% if user.is_authenticated %}
                                          {% url 'log-whatsapp' video.id %}
                                      {% else %}
                                          {% url 'user-login' %}?next={{ request.get_full_path|urlencode }}
                                      {% endif %}">
            <i class="fab fa-whatsapp fa-3x"></i>
            WhatsApp
        </a>
        
        <div class="action-item">
            <span class="material-icons">bookmark_border</span>
            Save
        </div>
        
        <a class="action-item" href="https://www.google.com/maps/search/?api=1&query={{ video.area|urlencode }},{{ video.city|urlencode }}"
           target="_blank" rel="noopener noreferrer">
            <span class="material-icons">location_on</span>
            Location
        </a>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
// Lazy load videos when they come into view
document.addEventListener('DOMContentLoaded', function() {
    const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('.reel-video');
            const loader = entry.target.querySelector('.video-loading');
            const source = video.querySelector('source');
            
            if (entry.isIntersecting) {
                // Load video when it's about to be visible
                if (!video.src && source.dataset.src) {
                    source.src = source.dataset.src;
                    video.src = video.dataset.src;
                    video.load();
                    
                    // Hide loader when video is ready
                    video.addEventListener('loadeddata', () => {
                        loader.style.display = 'none';
                        video.play();
                    }, { once: true });
                } else if (video.src) {
                    video.play();
                }
            } else {
                // Pause video when out of view to save resources
                if (video.src) {
                    video.pause();
                }
            }
        });
    }, {
        threshold: 0.5, // Video must be 50% visible
        rootMargin: '200px' // Start loading 200px before entering viewport
    });

    // Observe all reels
    document.querySelectorAll('.reel').forEach(reel => {
        videoObserver.observe(reel);
    });

    // Handle mute/unmute on video tap
    document.querySelectorAll('.reel-video').forEach(video => {
        video.addEventListener('click', function(e) {
            e.preventDefault();
            const muteIcon = this.closest('.reel').querySelector('.mute-status-icon');
            const icon = muteIcon.querySelector('.material-icons');
            
            if (this.muted) {
                this.muted = false;
                icon.textContent = 'volume_up';
            } else {
                this.muted = true;
                icon.textContent = 'volume_off';
            }
            
            // Show icon briefly
            muteIcon.style.opacity = '1';
            setTimeout(() => {
                muteIcon.style.opacity = '0';
            }, 500);
        });
    });
});
</script>